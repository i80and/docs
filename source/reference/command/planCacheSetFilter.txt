==================
planCacheSetFilter
==================

.. default-domain:: mongodb

Definition
----------

.. dbcommand:: planCacheSetFilter

   .. versionadded:: 2.6

   Set an :ref:`index filter <index-filters>` for a collection. If
   an index filter already exists for the :term:`query shape`, the
   command overrides the previous index filter.

   The command has the following syntax:

   .. code-block:: javascript

      db.runCommand(
         {
            planCacheSetFilter: <collection>,
            query: <query>,
            sort: <sort>,
            projection: <projection>,
            indexes: [ <index1>, <index2>, ...]
         }
      )

   The :dbcommand:`planCacheSetFilter` command has the following field:

   .. include:: /includes/apiargs/dbcommand-planCacheSetFilter-field.rst

   Index filters only exist for the duration of the server process and
   do not persist after shutdown; however, you can also clear existing
   index filters using the :dbcommand:`planCacheClearFilters` command.

.. _plancache-sharding-and-sorting:

Sharding and Sorting
--------------------

For a sharded collection, a query with a sort sent through a
:program:`mongos` will always include the sort key in each shard's list of
:term:`projected <project>` fields. Including the sort key allows the
:program:`mongos` instance to merge together the results from each shard in
sorted order. Consequently, the queries delivered to shards via
:program:`mongos` may have a different projection than that specified
by the user.

.. note::

   Include any sorting key in the index filter's ``projection`` field if the
   query will project fields from a sharded cluster. This ensures that the
   index filter's query shape correctly anticipates changes performed by
   :program:`mongos` to the projection.

Required Access
---------------

A user must have access that includes the
:authaction:`planCacheIndexFilter` action.

.. _planCacheSetFilter-output:

Examples
--------

Set Filter on Query Shape Consisting of Predicate Only
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The following example creates an index filter on the ``orders``
collection such that for queries that consists only of an equality
match on the ``status`` field without any projection and sort, the
query optimizer evaluates only the two specified indexes and the
collection scan for the winning plan:

.. code-block:: javascript

   db.runCommand(
      {
         planCacheSetFilter: "orders",
         query: { status: "A" },
         indexes: [
            { cust_id: 1, status: 1 },
            { status: 1, order_date: -1 }
         ]
      }
   )

In the query predicate, only the structure of the predicate, including
the field names, are significant; the values are insignificant. As
such, the created filter applies to the following operations:

.. code-block:: javascript

   db.orders.find( { status: "D" } )
   db.orders.find( { status: "P" } )

To see whether MongoDB will apply an index filter for a query shape,
check the :data:`~explain.queryPlanner.indexFilterSet` field of either
the :method:`db.collection.explain()` or the :method:`cursor.explain()`
method.

Set Filter on Query Shape Consisting of Predicate, Projection, and Sort
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

No Sharding
```````````

The following example creates an index filter for the ``orders``
collection. The filter applies to queries whose predicate is an
equality match on the ``item`` field, projecting only the ``quantity`` field,
and sorting in ascending order by ``order_date``.

.. code-block:: javascript

   db.runCommand(
      {
         planCacheSetFilter: "orders",
         query: { item: "ABC" },
         projection: { quantity: 1, _id: 0 },
         sort: { order_date: 1 },
         indexes: [
            { item: 1, order_date: 1 , quantity: 1 }
         ]
      }
   )

For the query shape, the query optimizer will only consider indexed
plans which use the index ``{ item: 1, order_date: 1, quantity: 1 }``.

Sharding
````````

If ``orders`` is a sharded collection, then you should include the
sort field ``order_date`` in the list of projected fields as discussed in
:ref:`plancache-sharding-and-sorting`.

The following example adds the missing fields to the projection.

.. code-block:: javascript

   db.runCommand(
      {
         planCacheSetFilter: "orders",
         query: { item: "ABC" },
         projection: { quantity: 1, order_date: 1, _id: 0 },
         sort: { order_date: 1 },
         indexes: [
            { item: 1, order_date: 1 , quantity: 1 }
         ]
      }
   )

.. seealso::
   :dbcommand:`planCacheClearFilters`,
   :dbcommand:`planCacheListFilters`
